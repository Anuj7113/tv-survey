<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CableTV Complaint System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-xl mx-auto bg-white rounded shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Register a Complaint</h2>
        <form class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                <select id="customerSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    <option value="">Loading customers...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">STB Number</label>
                <input id="stbNumber" type="text" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Customer Address</label>
                <textarea id="customerAddress" rows="2" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">GPS Location</label>
                <input id="customerLocation" type="text" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md">
            </div>
        </form>
    </div>
    <script>
    async function fetchCustomersFromSheet() {
        const select = document.getElementById('customerSelect');
        select.innerHTML = '<option value="">Loading customers...</option>';
        try {
            const res = await fetch('https://docs.google.com/spreadsheets/d/1JJTkkRTge4UGcAL3cUjliADULR_Cgj5Sc_S1j9Ou7S8/gviz/tq?tqx=out:json');
            const text = await res.text();
            const match = text.match(/(?<=\().*(?=\);)/s);
            if (!match) {
                select.innerHTML = '<option value="">Failed to load customers</option>';
                return;
            }
            const json = JSON.parse(match[0]);
            const rows = json.table.rows;
            select.innerHTML = '<option value="">Select a customer</option>';
            for(let idx = 0; idx < rows.length; idx++) {
                const row = rows[idx];
                // Defensive: log cell for debugging
                const firstCell = row && row.c && row.c[0] ? row.c[0].v : undefined;
                if (idx === 0) {
                    // Log what the header cell actually is
                    console.log('Header cell:', firstCell, 'Type:', typeof firstCell);
                }
                // Skip header only if cell is a string and includes stb
                if (
                    idx === 0 &&
                    typeof firstCell === "string" &&
                    firstCell.trim().toLowerCase().includes("stb")
                ) {
                    continue;
                }
                if(!row.c) continue;
                const stb = row.c[0] && row.c[0].v !== undefined ? row.c[0].v : '';
                const name = row.c[1] && row.c[1].v ? row.c[1].v : '';
                const address = row.c[2] && row.c[2].v ? row.c[2].v : '';
                const gps = row.c[3] && row.c[3].v ? row.c[3].v : '';
                if(!name) continue;
                const option = document.createElement('option');
                option.value = idx;
                option.dataset.stb = stb;
                option.dataset.name = name;
                option.dataset.address = address;
                option.dataset.gps = gps;
                option.textContent = stb ? `${name} (${stb})` : name;
                select.appendChild(option);
            }
        } catch (e) {
            select.innerHTML = '<option value="">Failed to load customers</option>';
            console.error(e);
        }
    }
    fetchCustomersFromSheet();

    document.addEventListener('DOMContentLoaded', () => {
        const select = document.getElementById('customerSelect');
        select.addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            document.getElementById('stbNumber').value = selected && selected.dataset.stb ? selected.dataset.stb : "";
            document.getElementById('customerAddress').value = selected && selected.dataset.address ? selected.dataset.address : "";
            document.getElementById('customerLocation').value = selected && selected.dataset.gps ? selected.dataset.gps : "";
        });
    });
    </script>
</body>
</html>
